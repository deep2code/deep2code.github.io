<!DOCTYPE html>
<html lang="zh" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.101.0" />
    <meta name="description" content="">
<meta name="author" content="deep2code">

    <link rel="icon" href="/images/favicon.jpeg" type="image/jpeg">

    <title>常用技巧 :: 技术博客</title>

    
    <link href="/css/nucleus.css?1677750506" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1677750506" rel="stylesheet">
    <link href="/css/hybrid.css?1677750506" rel="stylesheet">
    <link href="/css/featherlight.min.css?1677750506" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1677750506" rel="stylesheet">
    <link href="/css/auto-complete.css?1677750506" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1677750506" rel="stylesheet">
    <link href="/css/theme.css?1677750506" rel="stylesheet">
    <link href="/css/tabs.css?1677750506" rel="stylesheet">
    <link href="/css/hugo-theme.css?1677750506" rel="stylesheet">
    
    <link href="/css/theme-blue.css?1677750506" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1677750506"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/nginx/use/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="/"><img id="logo" src= "/images/logo.jpeg" ></img></a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1677750506"></script>
<script type="text/javascript" src="/js/auto-complete.js?1677750506"></script>
<script type="text/javascript">
    
        var baseurl = "\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1677750506"></script>

    
  </div>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/ai/" title="Ais" class="dd-item
        
        
        
        ">
      <a href="/ai/">
          Ais
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/ai/__index/" title="ai" class="dd-item ">
        <a href="/ai/__index/">
        ai
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/elastic/" title="elastic" class="dd-item
        
        
        
        ">
      <a href="/elastic/">
          elastic
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/flutter/" title="flutter" class="dd-item
        
        
        
        ">
      <a href="/flutter/">
          flutter
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/git/" title="git" class="dd-item
        
        
        
        ">
      <a href="/git/">
          git
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/golang/" title="golang" class="dd-item
        
        
        
        ">
      <a href="/golang/">
          golang
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/golang/context/" title="context" class="dd-item ">
        <a href="/golang/context/">
        context
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/echo/" title="echo" class="dd-item ">
        <a href="/golang/echo/">
        echo
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/regexp/" title="exgexp包" class="dd-item ">
        <a href="/golang/regexp/">
        exgexp包
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/freetype/" title="freetype" class="dd-item ">
        <a href="/golang/freetype/">
        freetype
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/gin/" title="gin" class="dd-item ">
        <a href="/golang/gin/">
        gin
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/go-git/" title="go-git" class="dd-item ">
        <a href="/golang/go-git/">
        go-git
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/io/" title="io包" class="dd-item ">
        <a href="/golang/io/">
        io包
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/iris/" title="iris" class="dd-item ">
        <a href="/golang/iris/">
        iris
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/log/" title="log" class="dd-item ">
        <a href="/golang/log/">
        log
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/shell/" title="shell" class="dd-item ">
        <a href="/golang/shell/">
        shell
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/sort/" title="sort包" class="dd-item ">
        <a href="/golang/sort/">
        sort包
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/stringer/" title="stringer" class="dd-item ">
        <a href="/golang/stringer/">
        stringer
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/package/" title="常用包" class="dd-item ">
        <a href="/golang/package/">
        常用包
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/code/" title="代码片断" class="dd-item ">
        <a href="/golang/code/">
        代码片断
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/generic/" title="泛型" class="dd-item ">
        <a href="/golang/generic/">
        泛型
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/golang/groupby/" title="泛型切片分组" class="dd-item ">
        <a href="/golang/groupby/">
        泛型切片分组
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/grpc/" title="grpc" class="dd-item
        
        
        
        ">
      <a href="/grpc/">
          grpc
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/grpc/golang/" title="golang示例" class="dd-item ">
        <a href="/grpc/golang/">
        golang示例
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/mac/" title="mac" class="dd-item
        
        
        
        ">
      <a href="/mac/">
          mac
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/memcached/" title="memcached" class="dd-item
        
        
        
        ">
      <a href="/memcached/">
          memcached
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/mysql/" title="mysql" class="dd-item
        
        
        
        ">
      <a href="/mysql/">
          mysql
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/nginx/" title="nginx" class="dd-item
        parent
        
        
        ">
      <a href="/nginx/">
          nginx
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/nginx/http/" title="HTTP模块" class="dd-item
        
        
        
        ">
      <a href="/nginx/http/">
          HTTP模块
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/nginx/rtmp/" title="rtmp" class="dd-item
        
        
        
        ">
      <a href="/nginx/rtmp/">
          rtmp
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/nginx/use/" title="常用技巧" class="dd-item
        
        active
        
        ">
      <a href="/nginx/use/">
          常用技巧
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/nginx/install/" title="源码安装剖析" class="dd-item
        
        
        
        ">
      <a href="/nginx/install/">
          源码安装剖析
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/python/" title="python" class="dd-item
        
        
        
        ">
      <a href="/python/">
          python
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/redis/" title="redis" class="dd-item
        
        
        
        ">
      <a href="/redis/">
          redis
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/other/" title="更多" class="dd-item
        
        
        
        ">
      <a href="/other/">
          更多
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/other/brew/" title="brew-酿制" class="dd-item
        
        
        
        ">
      <a href="/other/brew/">
          brew-酿制
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/docker/" title="docker" class="dd-item
        
        
        
        ">
      <a href="/other/docker/">
          docker
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/firefox/" title="firefox" class="dd-item
        
        
        
        ">
      <a href="/other/firefox/">
          firefox
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/github/" title="github" class="dd-item
        
        
        
        ">
      <a href="/other/github/">
          github
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/gitlab/" title="gitlab" class="dd-item
        
        
        
        ">
      <a href="/other/gitlab/">
          gitlab
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/harbor/" title="harbor" class="dd-item
        
        
        
        ">
      <a href="/other/harbor/">
          harbor
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/hugo/" title="hugo" class="dd-item
        
        
        
        ">
      <a href="/other/hugo/">
          hugo
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/machinelearn/" title="machinelearn" class="dd-item
        
        
        
        ">
      <a href="/other/machinelearn/">
          machinelearn
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/makefile/" title="makefile" class="dd-item
        
        
        
        ">
      <a href="/other/makefile/">
          makefile
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/markdown/" title="markdown" class="dd-item
        
        
        
        ">
      <a href="/other/markdown/">
          markdown
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/mermaid/" title="mermaid-美人鱼" class="dd-item
        
        
        
        ">
      <a href="/other/mermaid/">
          mermaid-美人鱼
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/rpc/" title="rpc" class="dd-item
        
        
        
        ">
      <a href="/other/rpc/">
          rpc
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/rust/" title="Rust" class="dd-item
        
        
        
        ">
      <a href="/other/rust/">
          Rust
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/shell/" title="shell" class="dd-item
        
        
        
        ">
      <a href="/other/shell/">
          shell
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/svn/" title="svn" class="dd-item
        
        
        
        ">
      <a href="/other/svn/">
          svn
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/tesseract/" title="tesseract" class="dd-item
        
        
        
        ">
      <a href="/other/tesseract/">
          tesseract
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/unity/" title="unity" class="dd-item
        
        
        
        ">
      <a href="/other/unity/">
          unity
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/other/unity/et/" title="ET框架" class="dd-item
        
        
        
        ">
      <a href="/other/unity/et/">
          ET框架
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/vim/" title="vim" class="dd-item
        
        
        
        ">
      <a href="/other/vim/">
          vim
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/wasm/" title="wasm" class="dd-item
        
        
        
        ">
      <a href="/other/wasm/">
          wasm
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/web/" title="web" class="dd-item
        
        
        
        ">
      <a href="/other/web/">
          web
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/windows/" title="windows" class="dd-item
        
        
        
        ">
      <a href="/other/windows/">
          windows
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/wireshark/" title="wireshark" class="dd-item
        
        
        
        ">
      <a href="/other/wireshark/">
          wireshark
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/aliyun/" title="阿里云" class="dd-item
        
        
        
        ">
      <a href="/other/aliyun/">
          阿里云
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/geocode/" title="地理编码" class="dd-item
        
        
        
        ">
      <a href="/other/geocode/">
          地理编码
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/search/" title="搜索技巧" class="dd-item
        
        
        
        ">
      <a href="/other/search/">
          搜索技巧
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/tencent/" title="腾讯" class="dd-item
        
        
        
        ">
      <a href="/other/tencent/">
          腾讯
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/other/opensource/" title="优秀开源软件" class="dd-item
        
        
        
        ">
      <a href="/other/opensource/">
          优秀开源软件
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    

    
    <section id="footer">
      

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>主页</a> > <a href='/nginx/'>nginx</a> > 常用技巧
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#配置片段">配置片段</a></li>
        <li><a href="#常用模块">常用模块</a></li>
        <li><a href="#常见问题">常见问题</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              常用技巧
            </h1>
          

        



	<h3 id="配置片段">配置片段</h3>
<hr>
<ul>
<li>
<p>http转向https</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^(.*)</span> <span style="color:#e6db74">https://</span>$server_name$1 <span style="color:#e6db74">permanent</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rewrite</span> <span style="color:#e6db74">^(.*)</span> <span style="color:#e6db74">https://</span>$host$1 <span style="color:#e6db74">permanent</span>;
</span></span></code></pre></div><ul>
<li>两种写法,各有适合场合</li>
<li>$server_name, 由nginx配置决定</li>
<li>$host,由请求路径决定</li>
</ul>
</li>
<li>
<p>正向代理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://</span>$host$request_uri;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>配合日志,可以用来调试</li>
<li>可以过滤掉特定请求</li>
<li>可以检查http请求是否被拦截</li>
</ul>
</li>
<li>
<p>解决无法加载样式表</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 否则无法加载样式表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">include</span> /etc/nginx/mime.types;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">default_type</span> <span style="color:#e6db74">application/octet-stream</span>;
</span></span></code></pre></div></li>
<li>
<p>支持http2</p>
<ul>
<li>
<p>自定义安装带上v2,ssl</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./configure --prefix<span style="color:#f92672">=</span>/Users/Shared/nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>            --with-http_v2_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>            --with-http_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>            --with-openssl<span style="color:#f92672">=</span>/opt/homebrew/Cellar/openssl@1.1/1.1.1m<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>            --with-debug
</span></span></code></pre></div></li>
<li>
<p>配置增加上http2</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 默认情况http2都走ssl,所以在ssl加上http2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span> <span style="color:#e6db74">http2</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">...</span>
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>支持http3</p>
<ul>
<li>
<p>自定义安装带上v3,ssl,brotli</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./auto/configure --with-http_v3_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --with-stream_quic_module      <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --with-http_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --with-http_v2_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --add-module<span style="color:#f92672">=</span>../ngx_brotli <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --with-cc-opt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-I../libressl/build/include&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --with-ld-opt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-L../libressl/build/lib&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>配置增加上http3</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">brotli</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">brotli_comp_level</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">brotli_types</span> <span style="color:#e6db74">text/plain</span> <span style="color:#e6db74">text/css</span> <span style="color:#e6db74">application/json</span> <span style="color:#e6db74">application/x-javascript</span> <span style="color:#e6db74">text/xml</span> <span style="color:#e6db74">application/xml</span> <span style="color:#e6db74">application/xml+rss</span> <span style="color:#e6db74">text/javascript</span> <span style="color:#e6db74">application/javascript</span> <span style="color:#e6db74">image/svg+xml</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 默认情况http2都走ssl,所以在ssl加上http2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span> <span style="color:#e6db74">http2</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">http3</span> <span style="color:#e6db74">reuseport</span>; <span style="color:#75715e"># UDP listener for QUIC+HTTP/3,在主域名表示reuseport，否则会提示冲突
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">ssl_protocols</span> <span style="color:#e6db74">TLSv1.3</span>; <span style="color:#75715e"># QUIC requires TLS 1.3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e"># 一定要添加头部，否则无法开启
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">add_header</span> <span style="color:#e6db74">alt-svc</span> <span style="color:#e6db74">&#39;h3=&#34;:443&#34;</span>; <span style="color:#f92672">ma=86400</span>;<span style="color:#f92672">quic=&#34;:443&#34;</span>; <span style="color:#f92672">ma=2592000</span>; <span style="color:#f92672">v=&#34;46,43&#34;,</span> <span style="color:#e6db74">h3-Q050=&#34;:443&#34;</span>; <span style="color:#f92672">ma=2592000,</span> <span style="color:#e6db74">h3-Q049=&#34;:443&#34;</span>; <span style="color:#f92672">ma=2592000,</span> <span style="color:#e6db74">h3-Q048=&#34;:443&#34;</span>; <span style="color:#f92672">ma=2592000,h3-Q046=&#34;:443&#34;</span>; <span style="color:#f92672">ma=2592000,</span> <span style="color:#e6db74">h3-Q043=&#34;:443&#34;</span>; <span style="color:#f92672">ma=2592000,</span> <span style="color:#e6db74">h3-23=&#34;:443&#34;</span>; <span style="color:#f92672">ma=2592000&#39;</span>; 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">...</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">...</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<p><img src="http3_brotli.webp" alt="效果图" title="效果图"></p>
<ul>
<li>
<p>四层代理-stream</p>
<ul>
<li>
<p>自定义安装带上stream</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./configure --prefix<span style="color:#f92672">=</span>/Users/Shared/nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>            --with-stream <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>            --with-debug
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>make <span style="color:#f92672">&amp;&amp;</span> make install
</span></span></code></pre></div></li>
<li>
<p>配置增加上stream</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">stream</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">listen</span> <span style="color:#ae81ff">8411</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_timeout</span> <span style="color:#e6db74">3s</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">proxy_pass</span> xxx:<span style="color:#ae81ff">8411</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>gzip-压缩支持</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">http</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 打开gzip指令，否则后面不会生效
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 回包头部增加content-encoding: gzip
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_vary</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 压缩类型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">gzip_types</span> <span style="color:#e6db74">text/plain</span> <span style="color:#e6db74">text/css</span> <span style="color:#e6db74">application/json</span> <span style="color:#e6db74">application/x-javascript</span> <span style="color:#e6db74">text/xml</span> <span style="color:#e6db74">application/xml</span> <span style="color:#e6db74">application/xml+rss</span> <span style="color:#e6db74">text/javascript</span> <span style="color:#e6db74">application/javascript</span> <span style="color:#e6db74">image/svg+xml</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span></code></pre></div></li>
<li>
<p><a href="http://nginx.org/en/docs/http/ngx_http_mirror_module.html">映像/复制mirror</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#可以多次映像/复制,从而起到放大流量功能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#产生一个http subrequest &#34;/mirror?&#34;,跳转到相应location
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#所以mirror结果(包括超时,服务器关闭,50x,40x等等),不影响这个本身速度及结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#但是占用内存,消费conn连接池之类还是要的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#mirror /mirror;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#mirror /mirror;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">mirror</span> <span style="color:#e6db74">/mirror</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#允许丢掉body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#mirror_request_body off;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://backend</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> = <span style="color:#e6db74">/mirror</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 判断请求方法，不是GET返回403,用其他类似手段缩小流量规模
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># if ($request_method != GET) {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#     return 403;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">internal</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#这里的回包是忽略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://test_backend</span>$request_uri;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#允许丢掉body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#proxy_pass_request_body off;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#proxy_set_header Content-Length &#34;&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Original-URI</span> $request_uri;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>利用日志调试</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#降低错误日志等级,例如notice,如果编译带有--with-debug,则可以debug,debug_http
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#e6db74">error_log</span>  <span style="color:#e6db74">logs/error.log</span>  <span style="color:#e6db74">info</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#不同路径不同access日志文件,确认哪个loc使用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">location</span> <span style="color:#e6db74">/hello</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">access_log</span> <span style="color:#e6db74">logs/hello_access.log</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">location</span> <span style="color:#e6db74">/world</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">access_log</span> <span style="color:#e6db74">logs/world_access.log</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">...</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span></code></pre></div></li>
<li>
<p>root与alias区别</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 请求/abc/123 ==&gt; /var/www/app/static/abc/123
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/abc</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># In case of the root directive, full path is appended to the root including the location part
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># 请求的path附加上root指定path,组合本地路径
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">root</span> <span style="color:#e6db74">/var/www/app/static</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">autoindex</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 请求/abc/123 ==&gt; /var/www/app/static/123
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/abc</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># only the portion of the path NOT including the location part is appended to the alias.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># 请求的path移除掉location的path,再附加上alias指定path,组合本地路径
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">alias</span> <span style="color:#e6db74">/var/www/app/static</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">autoindex</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="常用模块">常用模块</h3>
<hr>
<ul>
<li>
<p>http_memcached模块</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">/memcached</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">set</span> $memcached_key <span style="color:#e6db74">&#34;</span>$uri&#34;;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">memcached_pass</span> 127.0.0.1:<span style="color:#ae81ff">11211</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#指示返回为html,方便浏览器直接显示
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">default_type</span>   <span style="color:#e6db74">text/html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">404</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">504</span> = <span style="color:#e6db74">@notexit</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">@notexit</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#echo为第三方模块引入指令,方便调试
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">echo</span> <span style="color:#e6db74">&#34;noexit</span>$uri&#34;;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span></code></pre></div></li>
</ul>

<div class="mermaid" align="center">

sequenceDiagram
actor u as user
actor n as nginx
actor m as memcached
u->>n: http请求/memcached
n->>m: get命令key值为$uri(/memcached)
m->>n: 存在则返回值,否则返回空
n->>u: 成功获取,则直接返回,否则转跳notexit

</div>

<ul>
<li>
<p>ngx_http_redis第三方模块,类似http_memcached</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./configure --prefix<span style="color:#f92672">=</span>/Users/Shared/nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>            --add-module<span style="color:#f92672">=</span>../nginx-party-module/ngx_http_redis-module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>            ...
</span></span><span style="display:flex;"><span>            --with-debug
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>make <span style="color:#f92672">&amp;&amp;</span> make install
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> <span style="color:#e6db74">/redis</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">set</span> $redis_key <span style="color:#e6db74">&#34;</span>$uri&#34;;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">redis_pass</span>     127.0.0.1:<span style="color:#ae81ff">6379</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#指示返回为html,方便浏览器直接显示
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">default_type</span>   <span style="color:#e6db74">text/html</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">error_page</span> <span style="color:#ae81ff">404</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">504</span> = <span style="color:#e6db74">@notexit</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">@notexit</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#echo为第三方模块引入指令,方便调试
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">echo</span> <span style="color:#e6db74">&#34;noexit</span>$uri&#34;;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span></code></pre></div></li>
</ul>

<div class="mermaid" align="center">

sequenceDiagram
actor u as user
actor n as nginx
actor m as redis
u->>n: http请求/redis
n->>m: get命令key值为$uri(/redis)
m->>n: 存在则返回值,否则返回空
n->>u: 成功获取,则直接返回,否则转跳notexit

</div>

<ul>
<li>
<p>redis2-nginx-module第三方模块,更强大更多操作</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./configure --prefix<span style="color:#f92672">=</span>/Users/Shared/nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>            --add-module<span style="color:#f92672">=</span>../nginx-party-module/redis2-nginx-module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>            --with-debug
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>make install
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">location</span> = <span style="color:#e6db74">/foo</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">set</span> $value <span style="color:#e6db74">&#39;&lt;html&gt;&lt;H1&gt;From</span> <span style="color:#e6db74">Nginx</span> <span style="color:#e6db74">Redis&lt;/H1&gt;&lt;/html&gt;&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">redis2_query</span> <span style="color:#e6db74">set</span> <span style="color:#66d9ef">on</span><span style="color:#e6db74">e</span> $value;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">redis2_pass</span> 127.0.0.1:<span style="color:#ae81ff">6379</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">location</span> = <span style="color:#e6db74">/get</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">redis2_query</span> <span style="color:#e6db74">get</span> <span style="color:#66d9ef">on</span><span style="color:#e6db74">e</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">redis2_pass</span> 127.0.0.1:<span style="color:#ae81ff">6379</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">...</span>
</span></span></code></pre></div></li>
</ul>

<div class="mermaid" align="center">

sequenceDiagram
actor u as user
actor n as nginx
actor r as redis
u->>n: http请求/get
n->>r: get命令key值为one
r->>n: 标准命令处理
n->>u: 返回原始键值

</div>

<h3 id="常见问题">常见问题</h3>
<hr>
<ul>
<li>
<p>server_names_hash问题</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>emerg<span style="color:#f92672">]</span> could not build server_names_hash, you should increase server_names_hash_bucket_size: <span style="color:#ae81ff">32</span>
</span></span></code></pre></div></li>
<li>
<p>解决办法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#75715e"># 如果不够,继续增加,大小必须是32*n
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">server_names_hash_bucket_size</span> <span style="color:#ae81ff">64</span>;
</span></span></code></pre></div></li>
<li>
<p>invalid request问题</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># asscess.log 有这种提示</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;PRI * HTTP/2.0&#34;</span> <span style="color:#ae81ff">400</span> <span style="color:#ae81ff">157</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;-&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># error.log 有这种提示</span>
</span></span><span style="display:flex;"><span>client sent invalid request <span style="color:#66d9ef">while</span> reading client request line
</span></span></code></pre></div></li>
<li>
<p>解决办法-客户端没有采用ssl,tls,但访问nginx配置需要ssl</p>
</li>
<li>
<p>php-fpm出现Primary script unknown问题</p>
<ul>
<li>
<p>尝试修改nginx配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># FastCGI sent in stderr: &#34;Primary script unknown&#34; while reading response header from upstream,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">fastcgi_param</span> <span style="color:#e6db74">SCRIPT_FILENAME</span> $document_root$fastcgi_script_name;
</span></span></code></pre></div></li>
<li>
<p>如果仍然不行,则打开php-fpm.conf日志配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">access.log</span> = <span style="color:#e6db74">/var/log/php-fpm.</span>$pool.access.log
</span></span></code></pre></div></li>
<li>
<p>再打开nginx日志配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># http
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">log_format</span> <span style="color:#e6db74">scripts</span> <span style="color:#e6db74">&#39;</span>$document_root$fastcgi_script_name <span style="color:#e6db74">&gt;</span> $request&#39;;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># server
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">access_log</span> <span style="color:#e6db74">/usr/local/nginx/scripts.log</span> <span style="color:#e6db74">scripts</span>;
</span></span></code></pre></div></li>
<li>
<p>重启nginx,和php-fpm 查看日志,一般是路径不对和权限不对</p>
</li>
</ul>
</li>
<li>
<p>php-fpm出现无法连接数库,可能是编译参数不对</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>./configure --enable-fpm --prefix<span style="color:#f92672">=</span>/usr/local/php --with-mysqli<span style="color:#f92672">=</span>mysqlnd --with-pdo-mysql<span style="color:#f92672">=</span>mysqlnd
</span></span></code></pre></div></li>
<li>
<p>不知道当前nginx所用配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 获取nginx进程号</span>
</span></span><span style="display:flex;"><span>ps -ef | grep nginx
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取nginx路径</span>
</span></span><span style="display:flex;"><span>cd /proc/pid
</span></span><span style="display:flex;"><span>ls -a
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行相应路径的语法测试,输出就能看到路径</span>
</span></span><span style="display:flex;"><span>nginx -t
</span></span></code></pre></div></li>
<li>
<p>不知道当前nginx的编译参数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 获取nginx进程号</span>
</span></span><span style="display:flex;"><span>ps -ef | grep nginx
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取nginx路径</span>
</span></span><span style="display:flex;"><span>cd /proc/pid
</span></span><span style="display:flex;"><span>ls -a
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 执行相应路径的语法测试,输出就能看到路径</span>
</span></span><span style="display:flex;"><span>nginx -V
</span></span></code></pre></div></li>
</ul>





<footer class=" footline" >
	
</footer>


</div>


</div>

<div id="navigation">
    
    

    
    
    
    
    
    
    
    

    
    
    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    
    

    
    
    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    
    
    

    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    
    
    

    
    
    

    
    
    
    
    
    
    
    
    

    


    
    
    
    <a class="nav nav-prev" href="/nginx/rtmp/" title="rtmp"> <i class="fa fa-chevron-left"></i></a>
    
    
    <a class="nav nav-next" href="/nginx/install/" title="源码安装剖析" style="margin-right: 0px;"><i
            class="fa fa-chevron-right"></i></a>
    
    
</div>

</section>

<div
    style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
    <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
</div>
<script src="/js/clipboard.min.js?1677750506"></script>
<script src="/js/perfect-scrollbar.min.js?1677750506"></script>
<script src="/js/perfect-scrollbar.jquery.min.js?1677750506"></script>
<script src="/js/jquery.sticky.js?1677750506"></script>
<script src="/js/featherlight.min.js?1677750506"></script>
<script src="/js/highlight.pack.js?1677750506"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/js/modernizr.custom-3.6.0.js?1677750506"></script>
<script src="/js/learn.js?1677750506"></script>
<script src="/js/hugo-learn.js?1677750506"></script>


<script src="https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js"></script>

<script>
    mermaid.initialize({
        startOnLoad: true,
        sequence: {showSequenceNumbers: true},
    });
</script>



</body>

</html>